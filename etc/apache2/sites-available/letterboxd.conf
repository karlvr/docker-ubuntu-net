###############################################################################
# Main website
<VirtualHost *:80>
ServerName www.letterboxd.com
ServerAlias letterboxd.com boxd.it 10.100.*
DocumentRoot /srv/www/letterboxd/web

Include /opt/letterboxd/etc/apache2/letterboxd.conf

JkUnMount /assets/* letterboxd
JkUnMount /static/* letterboxd
JkUnMount /_maint/* letterboxd
JkUnMount /_stats/* letterboxd
JkMount /* letterboxd

RewriteEngine On
RewriteCond %{HTTP_HOST} !^(lb[0-9]+\.|)letterboxd\.com
RewriteCond %{HTTP_HOST} !^varnish\.letterboxd\.com$
RewriteCond %{HTTP_HOST} !^10\.100\.
RewriteCond %{HTTP_HOST} !^$
RewriteCond %{REQUEST_URI} !^/apple-app-site-association$
RewriteRule ^/(.*)$ http://letterboxd.com/$1 [R=301,NE]

# Performance reporting logging
#LogFormat "\"%r\" %t %D %B %>s" perf-baseline
#CustomLog ${APACHE_LOG_DIR}/letterboxd.log perf-baseline

# Forbid high page numbers for performance
#RewriteRule /page/[0-9][0-9][0-9]+/ - [F]
</VirtualHost>


###############################################################################
# API
<VirtualHost *:80>
ServerName api.letterboxd.com
# No permission to view this directory, so results in Forbidden
DocumentRoot /opt/letterboxd/www/blank

JkMount /api/* letterboxd

<Location "/WEB-INF/">
deny from all
</Location>
</VirtualHost>


###############################################################################
# Staging site
<VirtualHost *:80>
ServerName st.letterboxd.com
ServerAlias *.st.letterboxd.com st?.letterboxd.com
DocumentRoot /srv/www/staging/web

Include /opt/letterboxd/etc/apache2/letterboxd.conf

JkUnMount /assets/* staging
JkUnMount /static/* staging
JkUnMount /_maint/* staging
JkUnMount /_stats/* staging
JkMount /* staging
</VirtualHost>

<VirtualHost *:443>
ServerName st.letterboxd.com
ServerAlias st*.letterboxd.com
DocumentRoot /srv/www/staging/web

Include /opt/letterboxd/etc/apache2/letterboxd.conf

JkUnMount /assets/* staging
JkUnMount /static/* staging
JkUnMount /_maint/* staging
JkUnMount /_stats/* staging
JkMount /* staging

SSLEngine on
SSLCertificateFile /srv/www/letterboxd/ssl/2015/server.crt
SSLCertificateKeyFile /srv/www/letterboxd/ssl/2015/server.key
SSLCertificateChainFile /srv/www/letterboxd/ssl/2015/intermediate.crt

Include ssl.conf
</VirtualHost>


###############################################################################
# Server specific URLs such as app1.srv.letterboxd.com do not issue redirects, so we can use multiple
# host names for static asset parallel downloading advantage in browsers.
# Also we connect to the local app server so we can access the *.srv.letterboxd.com server to test the
# local Tomcat instance specifically.
<VirtualHost *:80>
ServerName srv.letterboxd.com
ServerAlias *.srv.letterboxd.com app?.letterboxd.com *.app?.letterboxd.com localhost 127.0.0.1
DocumentRoot /srv/www/letterboxd/web

Include /opt/letterboxd/etc/apache2/letterboxd.conf

JkUnMount /assets/* letterboxd
JkUnMount /static/* letterboxd
JkUnMount /_maint/* letterboxd
JkUnMount /_stats/* letterboxd
JkMount /* letterboxd

RewriteEngine On
# Static host: only allow access to our static asset paths
RewriteCond %{HTTP_HOST} static\.[^\.]+\.(srv\.|)letterboxd\.com
RewriteCond %{REQUEST_URI} !^/(static|css|js)/
RewriteRule .* - [F]

# Redirect users browsing non-static assets on our static asset servers
RewriteCond %{REQUEST_URI} !^/(assets|static|css|js)/
RewriteCond %{REQUEST_URI} !^/_
RewriteCond %{HTTP_HOST} [^\.]+\.[^\.]+\.(srv\.|)letterboxd\.com
RewriteRule (.*) http://letterboxd.com$1 [R]

RewriteRule /robots.txt /robots-direct.txt [PT]
</VirtualHost>

<VirtualHost *:443>
ServerName srv.letterboxd.com
ServerAlias app*.letterboxd.com localhost 127.0.0.1
DocumentRoot /srv/www/letterboxd/web

Include /opt/letterboxd/etc/apache2/letterboxd.conf

JkUnMount /assets/* letterboxd
JkUnMount /static/* letterboxd
JkUnMount /_maint/* letterboxd
JkUnMount /_stats/* letterboxd
JkMount /* letterboxd

RewriteEngine On
# Static host: only allow access to our static asset paths
RewriteCond %{HTTP_HOST} static\.[^\.]+\.(srv\.|)letterboxd\.com
RewriteCond %{REQUEST_URI} !^/(static|css|js)/
RewriteRule .* - [F]

# Redirect users browsing non-static assets on our static asset servers
RewriteCond %{REQUEST_URI} !^/(assets|static|css|js)/
RewriteCond %{REQUEST_URI} !^/_
RewriteCond %{HTTP_HOST} [^\.]+\.[^\.]+\.(srv\.|)letterboxd\.com
RewriteRule (.*) http://letterboxd.com$1 [R]

RewriteRule /robots.txt /robots-direct.txt [PT]

SSLEngine on
SSLCertificateFile /srv/www/letterboxd/ssl/2015/server.crt
SSLCertificateKeyFile /srv/www/letterboxd/ssl/2015/server.key
SSLCertificateChainFile /srv/www/letterboxd/ssl/2015/intermediate.crt

Include ssl.conf
</VirtualHost>


###############################################################################
# Legacy beta site
<VirtualHost *:80>
ServerName beta.letterboxd.com

RewriteEngine On
RewriteRule ^/$ http://letterboxd.com/?register [R]
RewriteRule ^/(.*)$ http://letterboxd.com/$1 [R=301,NE]
</VirtualHost>
