server {
        listen  443 ssl http2;
        listen  [::]:443 ssl http2;
        server_name     boxd.it;
        ssl_certificate /etc/letsencrypt/live/boxd.it/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/boxd.it/privkey.pem;

        include /opt/letterboxd/etc/nginx/ssl.conf;

        access_log off;

        include /opt/letterboxd/etc/nginx/gzip.conf;

        # Rewrite rules
        rewrite ^/robots.txt /robots-direct.txt last;
        rewrite ^/apple-app-site-association$ /apple-app-site-association.boxdit last;
        rewrite ^/(.*)$      /s/boxd-it?code=$1 last;

        location / {
                proxy_pass http://varnish;

                # http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive
                # HTTP/1.1 is required for the API as otherwise CXF gets nasty and returns empty responses
                proxy_http_version 1.1;
                proxy_set_header Connection "";

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;
                proxy_set_header X-Forwarded-Port 443;

                proxy_redirect off;
        }
}
