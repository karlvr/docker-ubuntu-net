server {
        listen  443 ssl http2;
        listen  [::]:443 ssl http2;
        server_name     boxd.it;
        ssl_certificate /etc/letsencrypt/live/boxd.it/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/boxd.it/privkey.pem;

        include /opt/letterboxd/etc/nginx/ssl.conf;

        access_log off;

        include /opt/letterboxd/etc/nginx/gzip.conf;
        
        include /opt/letterboxd/etc/nginx/boxdit.conf;

        location / {
                proxy_pass http://varnish;

                # http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive
                # HTTP/1.1 is required for the API as otherwise CXF gets nasty and returns empty responses
                proxy_http_version 1.1;
                proxy_set_header Connection "";

                # We pass the host as letterboxd.com as we've handled the boxd.it functionality and our Apache
                # servers can handle it as a request to letterboxd.com now.
                proxy_set_header Host letterboxd.com;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;
                proxy_set_header X-Forwarded-Port 443;

                proxy_redirect off;
        }
}
