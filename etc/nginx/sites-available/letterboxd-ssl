server {
        listen  443 ssl http2 default_server;
        listen  [::]:443 ssl http2 default_server; # IPv6 http://serverfault.com/questions/638367/do-you-need-separate-ipv4-and-ipv6-listen-directives-in-nginx
        server_name     letterboxd.com *.letterboxd.com;
        ssl_certificate /opt/letterboxd/etc/apache2/ssl/letterboxd.com/2016/server.pem;
        ssl_certificate_key /opt/letterboxd/etc/apache2/ssl/letterboxd.com/2016/server.key;

        include /opt/letterboxd/etc/nginx/ssl.conf;

        access_log off;

        include /opt/letterboxd/etc/nginx/gzip.conf;

        location / {
                proxy_pass http://varnish;

                # http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive
                # HTTP/1.1 is required for the API as otherwise CXF gets nasty and returns empty responses
                proxy_http_version 1.1;
                proxy_set_header Connection "";

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;
                proxy_set_header X-Forwarded-Port 443;

                proxy_redirect off;
        }
}
