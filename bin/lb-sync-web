#!/bin/bash
# 
# Syncs the Letterboxd staging web root to application servers
# usage: sync-server.sh <server>+

$(dirname $0)/lb-ssh-add
if [ $? != 0 ]; then
        exit 1
fi

for SERVER in $*
do
echo "Stopping application server..."
ssh $SERVER 'su - letterboxd -c "bin/shutdown.sh"'
RESULT=$?
echo "Waiting for shutdown..."
sleep 60
ssh $SERVER 'su - letterboxd -c "killall java"'
sleep 10
ssh $SERVER 'su - letterboxd -c "killall -9 java"'

echo "Syncing web root..."
rsync -av --stats  --delete /srv/www/staging/web $SERVER:/srv/www/letterboxd

echo "Starting application server..."
ssh $SERVER 'su - letterboxd -c "rm -rf work"'
ssh $SERVER 'su - letterboxd -c "bin/startup.sh"'
echo "Waiting for startup..."
# We wait for startup as if we're rolling the deploy we want to
# give the previous server time to get ready to serve
sleep 300
done
